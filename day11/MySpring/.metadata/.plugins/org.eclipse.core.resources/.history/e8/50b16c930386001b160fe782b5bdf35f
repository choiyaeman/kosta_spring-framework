package com.my.dao;

import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Repository;

//import com.my.dao.test.RepBoardDAOOracle;
import com.my.exception.AddException;
import com.my.exception.FindException;
import com.my.exception.ModifyException;
import com.my.exception.RemoveException;
//import com.my.sql.MyConnection;
import com.my.vo.RepBoard;

import lombok.extern.java.Log;
import lombok.extern.log4j.Log4j;

@Repository
@Qualifier(value = "oracle")
@Log4j
public class RepBoardDAOOracle implements RepBoardDAO {
	
//	데이터 소스 객체가 여려개일 경우
//	@Autowired
//	@Qualifier("hikarids")
	
	@Autowired
	private DataSource ds;
	
	public void delete(int board_no, String board_pwd) throws RemoveException{
		Connection con = null;
		try {
			//con = MyConnection.getConnection();
			con = ds.getConnection();
		}catch(Exception e) {
			throw new RemoveException(e.getMessage());
		}
		PreparedStatement pstmt = null;
		String deleteSQL = "DELETE repboard  where board_no = ? AND board_pwd = ?";
		try {
			pstmt = con.prepareStatement(deleteSQL);
			pstmt.setInt(1, board_no);
			pstmt.setString(2, board_pwd);
			int rowcnt = pstmt.executeUpdate();
			if(rowcnt == 0) {
				throw new RemoveException("글번호가 없거나 비밀번호가 다릅니다");
			}
		} catch (SQLException e) {
			throw new RemoveException(e.getMessage());
		}finally {
			//MyConnection.close(con, pstmt);
		}
	}
	public void update(RepBoard board, String board_pwd) throws ModifyException{
		Connection con = null;
		try {
			//con = MyConnection.getConnection();
			con = ds.getConnection();
		}catch(Exception e) {
			throw new ModifyException(e.getMessage());
		}
		PreparedStatement pstmt = null;
		String updateSQL1 = "UPDATE repboard SET ";
		boolean flag = false; 
		//제목
		if(board.getBoard_title() != null) {
			updateSQL1 += "board_title='"+ board.getBoard_title()+"'";
			flag = true;
		}
		
		//비밀번호
		if(flag) {
			updateSQL1 += ",";
		}
		if(board.getBoard_pwd() != null) {
			updateSQL1 += "board_pwd='"+ board.getBoard_pwd()+"'";
			flag = true;
		}
		System.out.println(updateSQL1);
		if(!flag) {
			throw new ModifyException("수정할 내용이 없습니다");
		}
		//----------
		String updateSQL2 = "\r\nWHERE board_no = "+board.getBoard_no()+
				" AND board_pwd = '"+ board_pwd +"'";
		String updateSQL = updateSQL1 + updateSQL2;
		try {
			pstmt = con.prepareStatement(updateSQL);
			int rowcnt = pstmt.executeUpdate();
			if(rowcnt == 0) {
				throw new ModifyException("글번호가 없거나 비밀번호가 다릅니다");
			}
		} catch (SQLException e) {
			throw new ModifyException(e.getMessage());
		}finally {
			//MyConnection.close(con, pstmt);
		}
	}

	public void updateBoardCnt(int board_no) throws ModifyException{
		Connection con = null;
		try {
			//con = MyConnection.getConnection();
			con = ds.getConnection();
		}catch(Exception e) {
			throw new ModifyException(e.getMessage());
		}
		PreparedStatement pstmt = null;
		String updateBoardCntSQL = "\r\n" + 
				"UPDATE repboard SET board_cnt = board_cnt+1\r\n" + 
				"WHERE board_no = ?";
		try {
			pstmt = con.prepareStatement(updateBoardCntSQL);
			pstmt.setInt(1, board_no);
			int rowcnt = pstmt.executeUpdate();
			if(rowcnt == 0) {
				throw new ModifyException("글번호가 없습니다");
			}
		} catch (SQLException e) {
			throw new ModifyException(e.getMessage());
		}finally {
			//MyConnection.close(con, pstmt);
		}
	}
	
	public RepBoard selectByBoard_no(int board_no) throws FindException{
		Connection con = null;
		try {
			//con = MyConnection.getConnection();
			con = ds.getConnection();
		}catch(Exception e) {
			throw new FindException(e.getMessage());
		}
		PreparedStatement pstmt = null;
		String selectAllSQL = "SELECT *\r\n" + 
				"FROM repboard\r\n" + 
				"WHERE board_no=?";
		ResultSet rs = null;
		try {
			pstmt = con.prepareStatement(selectAllSQL);
			pstmt.setInt(1, board_no);
			rs = pstmt.executeQuery();
			if(rs.next()) {
				int parent_no = rs.getInt("parent_no");
				String board_title = rs.getString("board_title");
				String board_writer = rs.getString("board_writer");
				Date board_dt = rs.getDate("board_dt");
				String board_pwd = rs.getString("board_pwd");
				int board_cnt = rs.getInt("board_cnt");
				RepBoard board = new RepBoard(board_no, parent_no, board_title, board_writer, board_dt, board_pwd, board_cnt);
				return board;
			}else{
				throw new FindException("게시글이 없습니다");
			}
		}catch(SQLException e) {
			throw new FindException(e.getMessage());
		}finally {
			//MyConnection.close(con, pstmt, rs);
		}
	}
	
	public List<RepBoard> selectByBoard_titleORBoard_writer(String word) throws FindException{
		Connection con = null;
		try {
			//con = MyConnection.getConnection();
			con = ds.getConnection();
		}catch(Exception e) {
			throw new FindException(e.getMessage());
		}
		PreparedStatement pstmt = null;
		String selectAllSQL = "SELECT repboard.*\r\n" + 
				"FROM repboard\r\n" + 
				"WHERE board_title LIKE ? OR board_writer LIKE ?\r\n" + 
				"ORDER BY board_no DESC";
		ResultSet rs = null;
		List<RepBoard> list = new ArrayList<>();
		try {
			pstmt = con.prepareStatement(selectAllSQL);
			pstmt.setString(1, "%"+word+"%");
			pstmt.setString(2, "%"+word+"%");
			rs = pstmt.executeQuery();
			while(rs.next()) {
				int board_no = rs.getInt("board_no");
				int parent_no = rs.getInt("parent_no");
				String board_title = rs.getString("board_title");
				String board_writer = rs.getString("board_writer");
				Date board_dt = rs.getDate("board_dt");
				String board_pwd = rs.getString("board_pwd");
				int board_cnt = rs.getInt("board_cnt");
				RepBoard board = new RepBoard(board_no, parent_no, board_title, board_writer, board_dt, board_pwd, board_cnt);
				list.add(board);
			}
			if(list.size() == 0) {
				throw new FindException("게시글이 없습니다");
			}
			return list;
		}catch(SQLException e) {
			throw new FindException(e.getMessage());
		}finally {
			//MyConnection.close(con, pstmt, rs);
		}
	}
	public List<RepBoard> selectAll() throws FindException{
		Connection con = null;
		//System.out.println("selectAll-1");
		
		//event level
		log.info("selectAll-1 : info");
		try {
			//con = MyConnection.getConnection();
			con = ds.getConnection();
		}catch(Exception e) {
			throw new FindException(e.getMessage());
		}
		//System.out.println("selectAll-2");
		log.debug("selectAll-2 : debug");
		PreparedStatement pstmt = null;
		String selectAllSQL = "SELECT level, repboard.*\r\n" + 
				"FROM repboard\r\n" + 
				"START WITH parent_no = 0\r\n" + 
				"CONNECT BY PRIOR board_no = parent_no\r\n" + 
				"ORDER SIBLINGS BY board_no DESC";
		//System.out.println("selectAll-3" + selectAllSQL);
		log.warn("selectAll-3 : warn" + selectAllSQL);
		ResultSet rs = null;
		List<RepBoard> list = new ArrayList<>();
		try {
			pstmt = con.prepareStatement(selectAllSQL);
			rs = pstmt.executeQuery();
			while(rs.next()) {
				int level = rs.getInt("level");
				int board_no = rs.getInt("board_no");
				int parent_no = rs.getInt("parent_no");
				String board_title = rs.getString("board_title");
				String board_writer = rs.getString("board_writer");
				Date board_dt = rs.getDate("board_dt");
				String board_pwd = rs.getString("board_pwd");
				int board_cnt = rs.getInt("board_cnt");
				RepBoard board = new RepBoard(level, board_no, parent_no, board_title, board_writer, board_dt, board_pwd, board_cnt);
				list.add(board);
			}
			//System.out.println("selectAll-4 list.size=" + list.size());
			log.error("selectAll-4 : error, list.size=" + list.size());
			if(list.size() == 0) {
				throw new FindException("게시글이 없습니다");
			}
			return list;
		}catch(SQLException e) {
			throw new FindException(e.getMessage());
		}finally {
			//MyConnection.close(con, pstmt, rs);
		}
	}
	public void insert(RepBoard board) throws AddException{
		Connection con = null;
		try {
			//con = MyConnection.getConnection();
			con = ds.getConnection();
		}catch(Exception e) {
			throw new AddException(e.getMessage());
		}
		PreparedStatement pstmt = null;
		String insertSQL = "INSERT INTO repboard(\r\n" + 
				"   board_no,               parent_no, board_title, board_writer, board_dt, BOARD_PWD, board_cnt)  VALUES    \r\n" + 
				"   (board_seq.NEXTVAL,             ?,            ?,          ?,   SYSDATE,    ?,         0)";
		
		try {
			pstmt = con.prepareStatement(insertSQL);
			pstmt.setInt(1, board.getParent_no());
			pstmt.setString(2, board.getBoard_title());
			pstmt.setString(3, board.getBoard_writer());
			pstmt.setString(4, board.getBoard_pwd());
			pstmt.executeUpdate();
		} catch (SQLException e) {
			e.printStackTrace();
			throw new AddException(e.getMessage());
		} finally {
			//MyConnection.close(con, pstmt);
		}	
	}
//	public static void main(String[] args) {
//		RepBoardDAOOracle dao = new RepBoardDAOOracle();
//
//	}
}