package com.my.control;

import java.io.IOException;
import java.util.List;

import javax.servlet.ServletException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.my.exception.AddException;
import com.my.exception.FindException;
import com.my.exception.ModifyException;
import com.my.exception.RemoveException;
import com.my.service.RepBoardService;
import com.my.vo.RepBoard;

import lombok.extern.log4j.Log4j;
@Controller
@Log4j
@RequestMapping("/board/*")
public class BoardController {
	@Autowired
	private RepBoardService service;
	
	@RequestMapping("/detail")
	public ModelAndView detail(int board_no) throws FindException {
//		String path ="/WEB-INF/views/error.jsp";
//		//1.요청전달데이터 얻기
//		String strBoard_no = request.getParameter("board_no");
//		int board_no = Integer.parseInt(strBoard_no);
		log.info("아이디:" + board_no);
		
		ModelAndView mnv = new ModelAndView();
		//try {
			//2.비지니스로직 호출
			RepBoard board = service.findByBoard_no(board_no);
			//3.요청속성으로 추가
			//request.setAttribute("board", board);
			mnv.addObject("board", board);
			
//		} catch (FindException e) {
//			//request.setAttribute("exception", e);
//			mnv.addObject("exception", e);
//			mnv.setViewName("error");
//			e.printStackTrace();
//		}
		//4.View로 이동
//		RequestDispatcher rd = request.getRequestDispatcher(path);
//		rd.forward(request, response);
		return mnv;
	}
	
	@RequestMapping("/list")
	public ModelAndView list(String word, 
			@RequestParam(required=false, defaultValue="0")int currentPage) throws FindException{
//		String path ="/WEB-INF/views/error.jsp";
//		request.setCharacterEncoding("utf-8");
		
		//1. 요청 전달데이터 얻기
		//String word = request.getParameter("word");
//		System.out.println(word);
		log.info("검색어:" + word);
		log.error("currentPage:" + currentPage);
		
		List<RepBoard> list;
		
		ModelAndView mnv = new ModelAndView(); //ModelAndView 객체생성
		//try {
			//2. 비지니스로직 호출
			if(word == null) { //전체검색
				list = service.findAll();
			}else { //검색어에 만족하는 검색
				list = service.findByBoard_titleORBoard_writer(word);
			}
			//3. 요청속성으로 호출결과값 추가
			//request.setAttribute("list", list);
			mnv.addObject("list", list);
			//path = "/WEB-INF/views/list.jsp";
			mnv.setViewName("list"); //view이름만 적어주면 된다
//		} catch (FindException e) {
//			//request.setAttribute("exception", e);
//			mnv.addObject("exception", e);
//			mnv.setViewName("error");
//			e.printStackTrace();
//		}
		//4. View로 이동
//		RequestDispatcher rd = request.getRequestDispatcher(path);
//		rd.forward(request, response);
		return mnv;
	}
	
	@RequestMapping("/modify")
	public ModelAndView modify(RepBoard board, 
			                   String certify_board_pwd) throws ModifyException{	
		ModelAndView mnv = new ModelAndView();
		//try {
			service.modify(board, certify_board_pwd);
			//path = "/WEB-INF/views/modify.jsp";
			//String contextPath = request.getContextPath();
			//response.sendRedirect(contextPath + "/list");
			mnv.setViewName("redirect:/list"); //앞에 접두어처럼 redirect를 붙이면 해당 view이름으로 리다이렉션된다
//		} catch (ModifyException e) {
//			//request.setAttribute("exception", e);
//			mnv.addObject("exception", e);
//			e.printStackTrace();
////			RequestDispatcher rd = request.getRequestDispatcher(path);
////			rd.forward(request, response);
//			mnv.setViewName("error"); //error.jsp로 알아서 forward
//		}
		return mnv;
	}
	
	@RequestMapping("/remove")
	public ModelAndView remove(int board_no, String certify_board_pwd) throws RemoveException{
		//request.setCharacterEncoding("utf-8");
		//String path ="/WEB-INF/views/error.jsp";
		//String strBoard_no = request.getParameter("board_no");
		//int board_no = Integer.parseInt(strBoard_no);
		//String certify_board_pwd = request.getParameter("certify_board_pwd");
		ModelAndView mnv = new ModelAndView();
		//try {
			service.remove(board_no, certify_board_pwd);
//			String contextPath = request.getContextPath();
//			response.sendRedirect(contextPath + "/list");
			mnv.setViewName("redirect:/list");
//		} catch (RemoveException e) {
//			//request.setAttribute("exception", e);
//			mnv.addObject("exception", e);
//			mnv.setViewName("error");
//			e.printStackTrace();
////			RequestDispatcher rd = request.getRequestDispatcher(path);
////			rd.forward(request, response);
//		}
		return mnv;
	}
	
	@RequestMapping("/reply")
	public ModelAndView reply(RepBoard board) throws AddException {
//		request.setCharacterEncoding("utf-8");
//		String path ="/WEB-INF/views/error.jsp";
//		//1.요청전달데이터 얻기
//		String strParent_no = request.getParameter("parent_no");
//		int parent_no = Integer.parseInt(strParent_no);
//		String board_title = request.getParameter("board_title");
//		String board_writer = request.getParameter("board_writer");
//		String board_pwd = request.getParameter("board_pwd");
//		RepBoard board = new RepBoard();
//		board.setParent_no(parent_no);
//		board.setBoard_title(board_title);
//		board.setBoard_writer(board_writer);;
//		board.setBoard_pwd(board_pwd);
		
		ModelAndView mnv = new ModelAndView();
		//try {
			service.writeReply(board);
//			String contextPath = request.getContextPath();
//			response.sendRedirect(contextPath + "/list");
			mnv.setViewName("redirect:/list");
//		} catch (AddException e) {
//			//request.setAttribute("exception", e);
//			mnv.addObject("exception", e);
//			mnv.setViewName("error");
//			e.printStackTrace();
////			RequestDispatcher rd = request.getRequestDispatcher(path);
////			rd.forward(request, response);
//		}
		return mnv;
	}
	
	@GetMapping("/write")
	//1번째 방법
	public void showWrite() { //view이름이나 요청된 url이 같을경우 void로 반환만 하면 된다 
//		String path ="/WEB-INF/views/write.jsp";
//		RequestDispatcher rd = request.getRequestDispatcher(path);
//		rd.forward(request, response);
		
//		ModelAndView mnv = new ModelAndView();
//		mnv.setViewName("write");
//		return;
	}
	//2번째 방법
//	public String showWrite() {
//		return "write"; //viewname만 반환해도 된다. 핸들러어뎁터가 jsp로 찾아낸다
//	}
	
	@PostMapping("/write")
	public ModelAndView write(RepBoard board, RedirectAttributes rttr) throws AddException{
		ModelAndView mnv = new ModelAndView();
		//try {
			service.writeBoard(board);
			//mnv.setViewName("redirect:/list");
			//mnv.setViewName("redirect:/list?currentPage=1"); //redirect가 됐을때 url에 CurrentPage가 나타날것을로 예상->비밀번호같은경우 보안노출우려
			rttr.addFlashAttribute("currentPage", 1); //주소 url을 보이지않고 자료가 전달되게하는 방법
			rttr.addFlashAttribute("word", "test");
			mnv.setViewName("redirect:/list");
//		} catch (AddException e) {	
//			mnv.addObject("exception", e);
//			e.printStackTrace();	
//		}
		return mnv;	
	}
}
