package com.my.control;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.servlet.http.HttpSession;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.my.exception.FindException;
import com.my.service.ProductService;
import com.my.vo.Product;

import lombok.extern.log4j.Log4j;

@Controller
@Log4j
public class CartController {
	@RequestMapping("/viewcart")
	@ResponseBody
	public Object view(HttpSession session) { // 요청 전달데이터 없으므로 매개변수도 없다
		Map<String, Integer> cart = (Map) session.getAttribute("cart");
		if (cart == null || cart.size() == 0) { // 장바구니가 없거나 장바구니가 비어있다면
			// out.print("{\"status\": -1}");
			Map<String, Integer> map = new HashMap();
			map.put("status", -1);
			return map;
		}
		// 장바구니가 있는 경우
		// 맵생성
		Map<Product, Integer> map = new HashMap<>();

		// 장바구니의 상품번호별 상품정보얻기
		Set<String> prod_nos = cart.keySet();
		ProductService service = new ProductService();
		for (String prod_no : prod_nos) {
			try {
				Product p = service.findByNo(prod_no);// 상품번호별 상품정보얻기
				int quantity = cart.get(prod_no);// 장바구니에 담긴 수량
				map.put(p, quantity); // 맵에 추가
			} catch (FindException e) {
				e.printStackTrace();
			}
		}

		List<Map<String, Object>> list = new ArrayList<>();
		for (Product p : map.keySet()) {
			Map<String, Object> map1 = new HashMap<>();
			map1.put("prod_no", p.getProd_no());
			map1.put("prod_name", p.getProd_name());
			map1.put("prod_price", p.getProd_price());
			int quantity = map.get(p);
			map1.put("quantity", quantity);
			list.add(map1);
		}
		return list;

	}


	@RequestMapping("/putcart")
	public ResponseEntity put(String prod_no, int quantity, HttpSession session) {
		// cart라는 이름의 속성값 얻기
		Map<String, Integer> cart = (Map) session.getAttribute("cart");

		// cart가 없으면
		if (cart == null) {
			cart = new HashMap<>();
			session.setAttribute("cart", cart);
		}

		// cart에서 상품번호에 해당하는 수량을 얻기
		Integer quantity2 = cart.get(prod_no);
		if (quantity2 != null) { // cart에 상품번호가 있는경우
			quantity += quantity2; // 수량을 증가
		}
		log.info("장바구니에 넣기할 상품번호:" + prod_no + ", 수량:" + quantity);
		// cart에 상품번호, 수량추가
		cart.put(prod_no, quantity);

		// 장바구니확인 테스트코드
		log.info("장바구니 넣기 확인");
		Set<String> keys = cart.keySet();// 키들
		for (String key : keys) {
			log.info(key + ":" + cart.get(key));
		}
		return new ResponseEntity<>(HttpStatus.OK);
	}
}
