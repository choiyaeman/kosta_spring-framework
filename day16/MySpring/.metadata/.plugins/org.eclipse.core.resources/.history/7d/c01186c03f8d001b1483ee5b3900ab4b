package com.my.control;

import java.io.IOException;
import java.util.List;

import javax.servlet.ServletException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.my.exception.AddException;
import com.my.exception.FindException;
import com.my.exception.ModifyException;
import com.my.exception.RemoveException;
import com.my.service.RepBoardService;
import com.my.vo.RepBoard;

import lombok.extern.log4j.Log4j;

@Controller
@Log4j
@RequestMapping("/board/*")
public class BoardController {
	@Autowired
	private RepBoardService service;

	@RequestMapping("/detail")
	public ModelAndView detail(int board_no) throws FindException {

		ModelAndView mnv = new ModelAndView();

		// 2.비지니스로직 호출
		RepBoard board = service.findByBoard_no(board_no);
		// 3.요청속성으로 추가
		// request.setAttribute("board", board);
		mnv.addObject("board", board);
		// mnv.setViewName()생략하면 URL인 mnv.setViewName("board/detail")과 같음

		return mnv;
	}

	@RequestMapping("/list")
	public ModelAndView list(String word, @RequestParam(required = false, defaultValue = "0") int currentPage)
			throws FindException {

		log.info("검색어:" + word);
		List<RepBoard> list;

		ModelAndView mnv = new ModelAndView(); // ModelAndView 객체생성

		// 2. 비지니스로직 호출
		if (word == null) { // 전체검색
			list = service.findAll();
		} else { // 검색어에 만족하는 검색
			list = service.findByBoard_titleORBoard_writer(word);
		}
		// 3. 요청속성으로 호출결과값 추가
		mnv.addObject("list", list);
		// mnv.setViewName("list");

		return mnv;
	}

	@RequestMapping("/modify")
	public ModelAndView modify(RepBoard board, String certify_board_pwd) throws ModifyException {
		ModelAndView mnv = new ModelAndView();
		service.modify(board, certify_board_pwd);
		mnv.setViewName("redirect:/board/list"); // 앞에 접두어처럼 redirect를 붙이면 해당 view이름으로 리다이렉션된다
		return mnv;
	}

	@RequestMapping("/remove")
	public ModelAndView remove(int board_no, String certify_board_pwd) throws RemoveException {

		ModelAndView mnv = new ModelAndView();
		service.remove(board_no, certify_board_pwd);
//			String contextPath = request.getContextPath();
//			response.sendRedirect(contextPath + "/list");
		mnv.setViewName("redirect:/board/list");
		return mnv;
	}

	@RequestMapping("/reply")
	public ModelAndView reply(RepBoard board) throws AddException {
		ModelAndView mnv = new ModelAndView();

		service.writeReply(board);
//			String contextPath = request.getContextPath();
//			response.sendRedirect(contextPath + "/list");
		mnv.setViewName("redirect:/board/list");
		return mnv;
	}

	@GetMapping("/write")
	// 1번째 방법
	public void showWrite() {
	}

	@PostMapping("/write")
	public ModelAndView write(RepBoard board, RedirectAttributes rttr) throws AddException {
		ModelAndView mnv = new ModelAndView();
		service.writeBoard(board);
		rttr.addFlashAttribute("currentPage", 1); // 주소 url을 보이지않고 자료가 전달되게하는 방법
		rttr.addFlashAttribute("word", "test");
		mnv.setViewName("redirect:/board/list");
		return mnv;
	}
}
