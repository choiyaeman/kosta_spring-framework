package com.my.control;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import com.my.exception.AddException;
import com.my.exception.FindException;
import com.my.exception.ModifyException;
import com.my.exception.RemoveException;
import com.my.service.RepBoardService;
import com.my.vo.PageGroupBean;
import com.my.vo.RepBoard;

import lombok.extern.log4j.Log4j;

@Controller
@RequestMapping("/board/*")
@Log4j
public class BoardController {
	@Autowired
	private RepBoardService service;

	@RequestMapping("/list")
//	public ModelAndView list(String word) throws FindException{
	public ModelAndView list(String word, 
			                @RequestParam(value = "currentPage", 
			                              required = false, 
			                              defaultValue = "1") int currentPage) throws FindException{	
	log.info("검색어:" + word);
		List<RepBoard> list;

		ModelAndView mnv = new ModelAndView();

		//2. 비지니스로직 호출
		if(word == null) { //전체검색
			//list = service.findAll();
			int cnt_per_page = 10;
			list = service.findAll(currentPage, cnt_per_page);//게시물 목록얻기
			int totalCnt = service.findCount(); //게시물전체수
			
//			//총페이지수 계산하기
//			int totalPage = (int)Math.ceil((double)totalCnt/cnt_per_page);
//			log.info("총게시물수:" + totalCnt + "총페이지수:" + totalPage);
//			mnv.addObject("totalPage", totalPage);
//			
//			int cnt_per_page_group = 3; //페이지 목록수
//			int startPage = ((currentPage-1)/cnt_per_page_group)*cnt_per_page_group+1;
//			int endPage = startPage+cnt_per_page_group-1;
//			if(totalPage<endPage) {
//				endPage = totalPage;
//			}
//			mnv.addObject("startPage", startPage);
//			mnv.addObject("endPage", endPage);
			String targetURL = "/board/list";
			PageGroupBean<RepBoard> pgb = new PageGroupBean<>(totalCnt, currentPage, list, targetURL); //변수선언할때 목록의 자료형을 적어주면 된다. 상품이면 <Product>, 주문이면 <OrderInfo>..
		}else { //검색어에 만족하는 검색
			list = service.findByBoard_titleORBoard_writer(word);
		}
		mnv.addObject("list", list);
		//mnv.setViewName("list");

		return mnv;
	}
	@RequestMapping("/detail")
	public ModelAndView detail(@RequestParam(value = "board_no", defaultValue = "0") 
	int board_no)  throws FindException {

		ModelAndView mnv = new ModelAndView();
		//try {
		//2. 비지니스로직 호출
		RepBoard board = service.findByBoard_no(board_no);
		//3. 요청속성으로 추가
		//request.setAttribute("board", board);
		mnv.addObject("board", board);
		//mnv.setViewName()생략하면 URL인 mnvsetViewName("board/detail")과 같음
		//} catch (FindException e) {
		//	mnv.addObject("exception", e);
		//	mnv.setViewName("board/error");
		//	e.printStackTrace();
		//}
		return mnv;
	}
	@RequestMapping("/modify")
	public ModelAndView modify(RepBoard board, 
			String certify_board_pwd) throws ModifyException{
		ModelAndView mnv = new ModelAndView();

		service.modify(board, certify_board_pwd);
		mnv.setViewName("redirect:/board/list");

		return mnv;
	}
	@RequestMapping("/remove")
	public ModelAndView remove(int board_no, String certify_board_pwd) throws RemoveException{
		ModelAndView mnv = new ModelAndView();
		//		try {
		service.remove(board_no, certify_board_pwd);
		//			String contextPath = request.getContextPath();
		//			response.sendRedirect(contextPath + "/list");
		mnv.setViewName("redirect:/board/list");

		return mnv;
	}
	@RequestMapping("/reply")
	public ModelAndView service(RepBoard board) throws AddException {
		ModelAndView mnv = new ModelAndView();
		//try {
		service.writeReply(board);
		mnv.setViewName("redirect:/board/list");

		return mnv;
	}
	@GetMapping("/write")
	public void showWrite() {}

	@PostMapping("/write")
	public ModelAndView write(RepBoard board) throws AddException{
		ModelAndView mnv = new ModelAndView();
		service.writeBoard(board);
		mnv.setViewName("redirect:/board/list");

		return mnv;
	}
}
